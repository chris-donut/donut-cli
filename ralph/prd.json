{
  "project": "Donut CLI - Phase 2 Completion + Phase 3 Intelligence Layer",
  "branchName": "ralph/phase2-phase3-intelligence",
  "description": "Complete Phase 2 Multi-Agent Foundation (risk hook wiring, PostgreSQL MCP) and implement Phase 3 Intelligence Layer (regime detection, performance attribution, confidence calibration, trade journal).",
  "userStories": [
    {
      "id": "US-013",
      "title": "Wire RiskManager into BaseAgent Tool Execution",
      "description": "As a trader, I want risk checks to run automatically before trade execution so that position limits are enforced",
      "acceptanceCriteria": [
        "Import RiskManager in base-agent.ts",
        "Add preToolUse hook call in processMessage() before tool execution",
        "Block high-risk tools if RiskManager returns { allowed: false }",
        "Log blocked trades with reason to console",
        "Add postToolUse hook call after successful tool execution",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Completed - getRiskManager() integrated with preToolUseHook/postToolUseHook, blockedTools set tracking"
    },
    {
      "id": "US-014",
      "title": "Create PostgreSQL MCP Server for Decision Persistence",
      "description": "As a developer, I want a PostgreSQL MCP server so that agent decisions and state can be persisted",
      "acceptanceCriteria": [
        "Create src/mcp-servers/postgres-server.ts",
        "Add pg and @types/pg dependencies",
        "Implement decision_log tool to insert decision records",
        "Implement decision_query tool to retrieve past decisions",
        "Implement state_save and state_load tools for agent state",
        "Read DATABASE_URL from environment",
        "Fall back gracefully if database unavailable",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Create Market Regime Detector Agent",
      "description": "As a trader, I want automatic market regime detection so that strategies adapt to conditions",
      "acceptanceCriteria": [
        "Create src/agents/regime-detector.ts",
        "Implement detectRegime(symbol) returning bull/bear/range/volatile",
        "Use moving average slopes and volatility indicators",
        "Add confidence score 0-1 for regime classification",
        "Cache regime for 1 hour to avoid excessive recalculation",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Create Performance Attribution System",
      "description": "As a trader, I want to understand why strategies win or lose",
      "acceptanceCriteria": [
        "Create src/analytics/attribution.ts",
        "Implement attributeByRegime() grouping PnL by market regime",
        "Implement attributeByTimeOfDay() grouping PnL by hour",
        "Implement attributeBySymbol() grouping PnL by asset",
        "Return ranked list of factors with contribution percentage",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-017",
      "title": "Create Confidence Calibration Tracker",
      "description": "As a trader, I want to track prediction accuracy to calibrate confidence",
      "acceptanceCriteria": [
        "Create src/analytics/calibration.ts",
        "Track predictions with confidence scores",
        "Compare predictions to actual outcomes",
        "Calculate calibration curve (predicted vs actual)",
        "Report over/under confidence bias",
        "Persist calibration data to .sessions/calibration.json",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-018",
      "title": "Create Trade Journal MCP Server",
      "description": "As a trader, I want a trade journal so that I can review decision rationale",
      "acceptanceCriteria": [
        "Create src/mcp-servers/journal-server.ts",
        "Implement journal_entry tool to log trade decisions with rationale",
        "Implement journal_search tool to find entries by date/symbol/tag",
        "Implement journal_summary tool to generate period summaries",
        "Store entries in .sessions/journal/ as markdown files",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    }
  ]
}

{
  "project": "Donut CLI - Dexter-Inspired Phase 2 Agent Improvements",
  "branchName": "ralph/dexter-phase2-agents",
  "description": "Agent architecture improvements inspired by Dexter: ReAct-style reasoning loop, context compaction for memory efficiency, iteration limits with graceful degradation, and enhanced agent observability.",
  "userStories": [
    {
      "id": "AG-001",
      "title": "Implement ReAct-Style Reasoning Loop",
      "description": "As an agent developer, I want explicit reasoning traces so that agent decisions are transparent and debuggable",
      "acceptanceCriteria": [
        "Create src/agents/reasoning.ts with ReasoningStep interface",
        "Include thought, action, observation, reflection fields",
        "Add scratchpad: ReasoningStep[] to BaseAgent",
        "Modify agent run loop to emit reasoning events",
        "Add getReasoningTrace() method to BaseAgent",
        "Emit agent:thinking events with thought content",
        "Persist reasoning trace in session state",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Created ReasoningScratchpad class with thought/action/observation/reflection tracking. Integrated into BaseAgent with getReasoningTrace() method. Emits agent:thinking events via eventBus. Trace included in AgentResult for debugging."
    },
    {
      "id": "AG-002",
      "title": "Add Context Compaction with Summaries",
      "description": "As a trader, I want long sessions to not run out of context so that I can have extended conversations",
      "acceptanceCriteria": [
        "Create src/agents/context-manager.ts with ContextManager class",
        "Implement summarizeToolResult(result) using fast model",
        "Add configurable summarization threshold (token count)",
        "Track context token usage with estimateTokens()",
        "Implement compactContext() to summarize oldest messages",
        "Add context usage to agent status",
        "Integrate with BaseAgent tool result handling",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Created ContextManager with token estimation, auto-summarization for large tool results, and compaction. Integrated into BaseAgent with getContextUsage() and compactContext() methods. Local summarization (no LLM) extracts key fields from JSON."
    },
    {
      "id": "AG-003",
      "title": "Add Iteration Limits with Graceful Degradation",
      "description": "As a developer, I want agents to not loop forever so that runaway agents are prevented",
      "acceptanceCriteria": [
        "Add maxIterations config to AgentConfig (default 25)",
        "Track iteration count in BaseAgent run loop",
        "When limit reached, generate progress summary instead of failing",
        "Implement generateProgressSummary() method",
        "Log warning when approaching limit (80% threshold)",
        "Emit agent:iteration_limit event when triggered",
        "Allow per-request iteration override",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Added maxIterations to AgentConfig, checkIterationLimit() and generateProgressSummary() methods. Warning at 80%, graceful summary at 100%. Emits agent:thinking event on limit."
    },
    {
      "id": "AG-004",
      "title": "Add Agent Factory Pattern",
      "description": "As a developer, I want async agent initialization so that setup is separated from construction",
      "acceptanceCriteria": [
        "Add static create() factory method to BaseAgent",
        "Move async initialization to create() method",
        "Make constructor private",
        "Add AgentBuilder fluent interface for configuration",
        "Support withModel(), withMaxIterations(), withTools() methods",
        "Update existing agent creation code to use factory",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Created AgentBuilder class with fluent interface. Supports withModel(), withMaxIterations(), withTools(), withDependencies(). Includes createAgent() and createAgentAsync() convenience functions. Constructor kept protected for backwards compatibility."
    },
    {
      "id": "AG-005",
      "title": "Add AbortSignal Support for Cancellation",
      "description": "As a user, I want to cancel long-running agent operations gracefully",
      "acceptanceCriteria": [
        "Add abortSignal?: AbortSignal to AgentConfig",
        "Check abortSignal.aborted in agent run loop",
        "Return partial results on abort instead of throwing",
        "Implement generatePartialResult() method",
        "Clean up resources on abort (close connections, save state)",
        "Log cancellation with context",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "AG-006",
      "title": "Add Agent Metrics and Observability",
      "description": "As a developer, I want agent execution metrics so that I can monitor and optimize performance",
      "acceptanceCriteria": [
        "Create src/agents/metrics.ts with AgentMetrics interface",
        "Track: totalIterations, toolCalls, tokenUsage, duration",
        "Track: successRate, averageToolDuration per tool",
        "Implement collectMetrics() method in BaseAgent",
        "Emit metrics on agent completion",
        "Add metrics to session state for historical analysis",
        "Export formatMetricsReport() for readable output",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    }
  ]
}
